<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Coffee Ratings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --card-bg: #2e1b0f;
            --muted: #bfa58a;
            --bg1: #0f0503;
            --bg2: #2b1206;
            --accent: #d6b58a;
        }

        html, body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            background: linear-gradient(180deg, var(--bg1), var(--bg2));
            color: #f6efe6;
            overscroll-behavior-y: contain;
        }

        /* Custom coffee-themed palette overrides */
        .bg-neutral-900 {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.08));
            background-color: var(--card-bg) !important;
        }
        .bg-neutral-800 { background-color: rgba(255, 255, 255, 0.02); }
        input, textarea, select { color: #efe6db; }
        .text-gray-400, .fa-solid { color: var(--muted); }
        .coffee-btn {
            background: linear-gradient(180deg, #f6e6d9, #e7d2b1);
            color: #2e1508;
        }
        .cancel-btn {
            background: linear-gradient(180deg, #555, #333);
            color: #f0f0f0;
        }
        .delete-btn { color: #ff8a8a; }
        .edit-btn { color: var(--accent); }

        /* Animations */
        @keyframes floaty { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        h1.floaty { animation: floaty 6s ease-in-out infinite; }
        
        @keyframes enterFromBelow {
            from { opacity: 0; transform: translateY(14px) scale(.995); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes pop {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.12); }
        }
        @keyframes rippleAnim {
            to { transform: translate(-50%, -50%) scale(6); opacity: 0; }
        }
        .ripple {
            position: absolute; border-radius: 9999px; transform: translate(-50%, -50%) scale(0);
            opacity: .6; pointer-events: none;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.04) 40%, rgba(255, 255, 255, 0) 60%);
            animation: rippleAnim .7s ease-out forwards; will-change: transform, opacity;
        }

        /* Toast Notification */
        .toast {
            position: fixed; right: 16px; bottom: 20px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
            color: #e6e6e6; padding: 10px 14px; border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.45); backdrop-filter: blur(6px);
            transform: translateY(12px); opacity: 0;
            transition: transform 300ms ease, opacity 300ms ease;
            z-index: 60; font-weight: 600;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        
        /* Mobile-First & Interactive Styles */
        .pressed {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
            transition: transform 160ms cubic-bezier(.2, .9, .2, 1), box-shadow 160ms ease;
        }
        .focus-lift:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45), 0 0 0 4px rgba(255, 255, 255, 0.02) inset;
        }
        .transition-smooth { transition: all 220ms cubic-bezier(.2, .9, .2, 1); }
        .coffee-item { will-change: transform, box-shadow, max-height, opacity, margin, padding; }
        .tap-target { padding: 18px; border-radius: 14px; font-size: 16px; }
        .big-btn { padding: 14px; border-radius: 12px; font-size: 17px; }
        .item-exit {
            opacity: 0;
            transform: scale(0.95);
            max-height: 0px !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            border-width: 0 !important;
        }
        
        /* Splash Screen (unchanged from original) */
        #splash { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, rgba(11, 6, 4, 0.85), rgba(8, 4, 2, 0.9)); z-index: 80; pointer-events: auto; transition: opacity 420ms ease, transform 420ms ease; opacity: 1; }
        #splash.hide { opacity: 0; transform: translateY(-8px); pointer-events: none; }
        .mug-svg { width: 160px; height: 160px; display: block; }
        .coffee-fill { transform-origin: 50% 100%; transform: scaleY(0); fill: #6b3f2a; animation: fillUp 900ms cubic-bezier(.2, .9, .2, 1) 240ms forwards; }
        .steam { fill: none; stroke: rgba(255, 255, 255, 0.85); stroke-width: 2; stroke-linecap: round; opacity: 0; transform-origin: center; animation: steamRise 1200ms ease 900ms forwards; }
        .steam.s1 { animation-delay: 1000ms; } .steam.s2 { animation-delay: 1150ms; } .steam.s3 { animation-delay: 1300ms; }
        @keyframes fillUp { from { transform: scaleY(0); } to { transform: scaleY(1); } }
        @keyframes steamRise { from { opacity: 0; transform: translateY(6px) scale(0.9); } to { opacity: 1; transform: translateY(-18px) scale(1); } }

        /* Remove default outlines for a cleaner look */
        button:focus, select:focus, input:focus, textarea:focus { outline: none; box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35); }
    </style>
</head>

<body class="bg-black text-gray-100 min-h-screen flex flex-col items-center py-10 font-sans px-4">

    <div id="splash">
         <svg class="mug-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><clipPath id="cupClip"><rect x="18" y="34" width="84" height="50" rx="8" /></clipPath></defs>
            <circle cx="60" cy="60" r="58" fill="rgba(255,255,255,0.02)" />
            <g clip-path="url(#cupClip)">
                <rect class="coffee-fill" x="29" y="20" width="50" height="50" rx="8" fill="#5a3724" opacity="0">
                    <animate attributeName="opacity" dur="900ms" begin="240ms" values="0;0;1" keyTimes="0;0.72;1" fill="freeze" />
                </rect>
            </g>
            <g stroke="#efe6db" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M28 34h52v24a12 12 0 0 1-12 12H40a12 12 0 0 1-12-12V34z" />
                <path d="M80 46c6 0 10-4 10-10s-4-10-10-10" />
            </g>
            <path d="M44 28c4-4 14-2 18 2" stroke="rgba(255,255,255,0.06)" stroke-width="1.6" fill="none" stroke-linecap="round" />
            <path class="steam s1" d="M46 24c4-6 8-6 8-10s-4-6-6-2" stroke-linejoin="round" />
            <path class="steam s2" d="M58 26c3-5 6-5 6-9s-3-5-5-2" stroke-linejoin="round" />
            <path class="steam s3" d="M70 25c3-5 6-5 6-9s-3-5-5-2" stroke-linejoin="round" />
        </svg>
    </div>

    <h1 class="text-3xl sm:text-4xl font-bold tracking-tight mb-6 floaty text-center">Coffee Ratings</h1>

    <div class="w-full max-w-md space-y-4">
        <details class="bg-neutral-900 rounded-xl shadow-lg transition transform-gpu" open>
            <summary class="p-5 font-semibold text-lg cursor-pointer">Add New Coffee</summary>
            <div id="formCard" class="p-5 pt-0 space-y-4">
                <input id="name" type="text" placeholder="Coffee name" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded transition-smooth focus-lift" />
                <select id="person" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded transition-smooth focus-lift"></select>
                <input id="place" type="text" placeholder="Place" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded transition-smooth focus-lift" />
                <div>
                    <label for="rate" class="block text-sm mb-2 text-gray-400"><i class="fa-solid fa-star mr-2"></i>Rate</label>
                    <div class="flex items-center space-x-4">
                        <input id="rate" type="range" min="1" max="10" value="5" class="flex-grow accent-gray-500 cursor-pointer transition-smooth" />
                        <span id="rateValue" class="text-lg font-semibold text-gray-200 w-9 text-center">5</span>
                    </div>
                </div>
                <textarea id="megjegyzes" placeholder="MegjegyzÃ©s" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded transition-smooth focus-lift"></textarea>
                <div class="flex gap-3">
                    <button id="addBtn" class="w-full coffee-btn font-semibold px-4 py-3 big-btn rounded transition relative overflow-hidden">Add Coffee</button>
                    <button id="cancelBtn" class="w-full cancel-btn font-semibold px-4 py-3 big-btn rounded transition relative overflow-hidden hidden">Cancel Edit</button>
                </div>
            </div>
        </details>

        <details class="bg-neutral-900 rounded-xl shadow-lg transition transform-gpu">
             <summary class="p-5 font-semibold text-lg cursor-pointer">Search & Filter</summary>
            <div class="p-5 pt-0 space-y-4">
                <div id="searchCard" class="bg-neutral-900 rounded-xl p-3 flex items-center space-x-3 transition-smooth">
                    <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                    <input id="search" type="text" placeholder="Search coffee name..." class="flex-grow p-2 bg-transparent border-none rounded focus:outline-none" />
                </div>
                <div id="filtersCard" class="bg-neutral-900 rounded-xl flex flex-col gap-3 transition-smooth">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 flex items-center"><i class="fa-solid fa-user mr-2"></i>Person</label>
                        <select id="personFilter" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded transition-smooth focus:outline-none"></select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 flex items-center"><i class="fa-solid fa-location-dot mr-2"></i>Place</label>
                        <select id="placeFilter" class="w-full p-3 bg-neutral-800 border border-neutral-700 rounded transition-smooth focus:outline-none"></select>
                    </div>
                </div>
            </div>
        </details>

        <ul id="coffeeList" class="space-y-4"></ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ð Replace with your JSONbin values
            const API_KEY = "$2a$10$J7fi24LcCk1TF8IfMHC4.e/IaKxCzRvCdOdE5F3YrDVrMRjhID4lC";
            const BIN_ID = "68c2f61cd0ea881f407a843e";
            const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

            let coffeesData = [];
            let editState = { isEditing: false, coffeeId: null };

            // DOM Element References
            const getEl = (id) => document.getElementById(id);
            const form = {
                name: getEl('name'),
                person: getEl('person'),
                place: getEl('place'),
                rate: getEl('rate'),
                rateValue: getEl('rateValue'),
                megjegyzes: getEl('megjegyzes'),
                addBtn: getEl('addBtn'),
                cancelBtn: getEl('cancelBtn'),
                formCard: getEl('formCard'),
                formDetails: getEl('formCard').closest('details')
            };
            const filters = {
                search: getEl('search'),
                person: getEl('personFilter'),
                place: getEl('placeFilter'),
                filtersCard: getEl('filtersCard'),
                searchCard: getEl('searchCard')
            };
            const coffeeList = getEl('coffeeList');
            const splash = getEl('splash');

            // --- UTILITY FUNCTIONS ---
            const escapeHtml = (s = "") => String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;");

            const showToast = (text = "Saved", duration = 2000) => {
                const t = document.createElement("div");
                t.className = "toast";
                t.textContent = text;
                document.body.appendChild(t);
                requestAnimationFrame(() => t.classList.add("show"));
                setTimeout(() => {
                    t.classList.remove("show");
                    setTimeout(() => t.remove(), 360);
                }, duration);
            };
            
            const triggerHapticFeedback = () => {
                if (navigator.vibrate) navigator.vibrate(50);
            };

            const createRipple = (ev, parent) => {
                const rect = parent.getBoundingClientRect();
                const x = (ev.clientX || rect.left + rect.width / 2) - rect.left;
                const y = (ev.clientY || rect.top + rect.height / 2) - rect.top;
                const ripple = document.createElement("span");
                ripple.className = "ripple";
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                ripple.style.width = ripple.style.height = `${Math.max(rect.width, rect.height)}px`;
                parent.appendChild(ripple);
                setTimeout(() => ripple.remove(), 800);
            };
            
            // --- API FUNCTIONS ---
            const updateRemoteData = async (data) => {
                try {
                    await fetch(BASE_URL, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                        body: JSON.stringify(data)
                    });
                    return true;
                } catch (e) {
                    console.error("Failed to update remote data", e);
                    showToast("Error saving data!", 3000);
                    return false;
                }
            };
            
            const fetchCoffees = async () => {
                try {
                    const res = await fetch(`${BASE_URL}/latest`, { headers: { "X-Master-Key": API_KEY } });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    coffeesData = (data.record || []).sort((a, b) => b.id - a.id);
                    updateFiltersAndForm();
                    renderCoffees();
                } catch (e) {
                    console.error("Failed to fetch coffees", e);
                    showToast("Could not load data.", 3000);
                }
            };

            // --- CORE LOGIC: EDIT, DELETE, ADD ---
            const startEdit = (coffeeId) => {
                const coffee = coffeesData.find(c => c.id === coffeeId);
                if (!coffee) return;

                editState = { isEditing: true, coffeeId };

                form.name.value = coffee.name;
                form.person.value = coffee.person;
                form.place.value = coffee.place;
                form.rate.value = coffee.rate;
                form.rateValue.textContent = coffee.rate;
                form.megjegyzes.value = coffee.megjegyzes;

                form.addBtn.textContent = "Update Coffee";
                form.cancelBtn.classList.remove('hidden');
                form.formDetails.open = true;
                form.formCard.scrollIntoView({ behavior: 'smooth' });
                triggerHapticFeedback();
            };

            const cancelEdit = () => {
                editState = { isEditing: false, coffeeId: null };
                form.addBtn.textContent = "Add Coffee";
                form.cancelBtn.classList.add('hidden');
                form.formCard.reset ? form.formCard.reset() : (() => {
                    form.name.value = ''; form.place.value = ''; form.megjegyzes.value = '';
                    form.rate.value = 5; form.rateValue.textContent = '5';
                })();
            };

            const deleteCoffee = async (coffeeId) => {
                if (!confirm("Are you sure you want to delete this entry?")) return;
                
                const initialData = [...coffeesData];
                coffeesData = coffeesData.filter(c => c.id !== coffeeId);
                
                const elToRemove = coffeeList.querySelector(`[data-coffee-id='${coffeeId}']`);
                if(elToRemove) {
                    elToRemove.classList.add('item-exit');
                    elToRemove.addEventListener('transitionend', () => elToRemove.remove(), { once: true });
                }

                const success = await updateRemoteData(coffeesData);
                if (success) {
                    showToast("Coffee deleted");
                    updateFiltersAndForm();
                } else {
                    coffeesData = initialData; // Revert on failure
                    renderCoffees(); // Re-render to restore the item
                }
            };
            
            const handleFormSubmit = async (ev) => {
                createRipple(ev, form.addBtn);
                triggerHapticFeedback();

                const coffeeData = {
                    name: form.name.value.trim(),
                    person: form.person.value.trim(),
                    place: form.place.value.trim(),
                    rate: form.rate.value,
                    megjegyzes: form.megjegyzes.value.trim()
                };
                if (!coffeeData.name) return showToast("Coffee name is required.", 2000);

                if (editState.isEditing) { // --- UPDATE LOGIC ---
                    const index = coffeesData.findIndex(c => c.id === editState.coffeeId);
                    if (index === -1) return;
                    
                    const updatedCoffee = { ...coffeesData[index], ...coffeeData };
                    coffeesData[index] = updatedCoffee;
                    
                    if (await updateRemoteData(coffeesData)) {
                        const newElement = createCoffeeElement(updatedCoffee);
                        const oldElement = coffeeList.querySelector(`[data-coffee-id='${updatedCoffee.id}']`);
                        if (oldElement) oldElement.replaceWith(newElement);
                        showToast("Coffee updated");
                        cancelEdit();
                    }
                } else { // --- ADD NEW LOGIC ---
                    const newCoffee = { ...coffeeData, id: Date.now() };
                    const updatedData = [newCoffee, ...coffeesData];
                    
                    if (await updateRemoteData(updatedData)) {
                        coffeesData = updatedData;
                        const newElement = createCoffeeElement(newCoffee);
                        coffeeList.prepend(newElement);
                        requestAnimationFrame(() => newElement.style.animation = `enterFromBelow 360ms cubic-bezier(.2,.9,.2,1) forwards`);
                        showToast("Coffee added");
                        cancelEdit();
                        updateFiltersAndForm();
                    }
                }
            };
            
            // --- UI & RENDERING ---
            const updateFiltersAndForm = () => {
                const basePersons = ['Virag', 'Samy'];
                const dynamicPersons = coffeesData.map(c => (c.person || "").trim()).filter(Boolean);
                const allPersons = Array.from(new Set([...basePersons, ...dynamicPersons])).sort();
                const places = Array.from(new Set(coffeesData.map(c => (c.place || "").trim()).filter(Boolean))).sort();

                const populateSelect = (selectEl, items, currentVal = "") => {
                    const optionsHtml = items.map(p => `<option value="${escapeHtml(p)}"${p === currentVal ? ' selected' : ''}>${escapeHtml(p)}</option>`).join("");
                    if (selectEl === filters.person || selectEl === filters.place) {
                        selectEl.innerHTML = `<option value="">All</option>` + optionsHtml;
                    } else {
                         selectEl.innerHTML = optionsHtml;
                    }
                };
                populateSelect(form.person, allPersons);
                populateSelect(filters.person, allPersons, filters.person.value);
                populateSelect(filters.place, places, filters.place.value);
            };

            const createCoffeeElement = (c) => {
                const li = document.createElement("li");
                li.className = "bg-neutral-900 tap-target coffee-item transition-all duration-300 ease-in-out";
                li.dataset.coffeeId = c.id;

                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="font-semibold text-lg">${escapeHtml(c.name)}</p>
                            <p class="text-gray-200 font-bold text-base">${escapeHtml(String(c.rate))} / 10</p>
                        </div>
                        <div class="relative">
                            <button class="actions-btn p-2 -mr-2 text-gray-400"><i class="fa-solid fa-ellipsis-v"></i></button>
                            <div class="actions-menu absolute right-0 mt-2 w-32 bg-neutral-800 rounded-lg shadow-xl hidden z-10 overflow-hidden">
                                <button class="edit-btn w-full text-left px-4 py-2 hover:bg-black/20"><i class="fa-solid fa-pencil mr-2"></i>Edit</button>
                                <button class="delete-btn w-full text-left px-4 py-2 hover:bg-black/20"><i class="fa-solid fa-trash mr-2"></i>Delete</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 space-y-1 text-sm text-gray-400">
                        ${c.person ? `<p><i class="fa-solid fa-user mr-2 text-gray-400"></i>${escapeHtml(c.person)}</p>` : ""}
                        ${c.place ? `<p><i class="fa-solid fa-location-dot mr-2 text-gray-400"></i>${escapeHtml(c.place)}</p>` : ""}
                        ${c.megjegyzes ? `<p class="pt-1"><i class="fa-solid fa-comment mr-2 text-gray-400"></i>${escapeHtml(c.megjegyzes)}</p>` : ""}
                    </div>
                `;
                
                // Event listeners for actions menu
                const actionsBtn = li.querySelector('.actions-btn');
                const actionsMenu = li.querySelector('.actions-menu');
                
                actionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.actions-menu').forEach(menu => {
                         if(menu !== actionsMenu) menu.classList.add('hidden');
                    });
                    actionsMenu.classList.toggle('hidden');
                });
                li.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); startEdit(c.id); });
                li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteCoffee(c.id); });

                return li;
            };

            const renderCoffees = () => {
                const q = (filters.search.value || "").trim().toLowerCase();
                const personSel = filters.person.value;
                const placeSel = filters.place.value;

                const filtered = coffeesData.filter(c => 
                    (!q || (c.name || "").toLowerCase().includes(q)) &&
                    (!personSel || (c.person || "") === personSel) &&
                    (!placeSel || (c.place || "") === placeSel)
                );

                coffeeList.innerHTML = ""; // Clear only on full re-render (filter/search)
                if (filtered.length === 0) {
                    coffeeList.innerHTML = `<li class="text-gray-400 px-2 text-center py-4">No coffees found.</li>`;
                    return;
                }
                filtered.forEach((c, idx) => {
                    const li = createCoffeeElement(c);
                    li.style.animation = `enterFromBelow 360ms cubic-bezier(.2,.9,.2,1) forwards ${idx * 60}ms`;
                    coffeeList.appendChild(li);
                });
            };

            // --- EVENT LISTENERS ---
            form.rate.addEventListener("input", () => {
                form.rateValue.textContent = form.rate.value;
                form.rateValue.style.animation = "pop 420ms cubic-bezier(.2,.9,.2,1)";
                form.rateValue.addEventListener("animationend", () => form.rateValue.style.animation = "", { once: true });
            });
            form.addBtn.addEventListener("click", handleFormSubmit);
            form.cancelBtn.addEventListener("click", cancelEdit);

            let filterTimer;
            const onFilterChange = () => {
                clearTimeout(filterTimer);
                filterTimer = setTimeout(renderCoffees, 200); // Debounce filtering
            };
            filters.search.addEventListener("input", onFilterChange);
            filters.person.addEventListener("change", onFilterChange);
            filters.place.addEventListener("change", onFilterChange);

            // Close actions menus if clicking elsewhere
            window.addEventListener('click', (e) => {
                if (!e.target.closest('.actions-btn')) {
                    document.querySelectorAll('.actions-menu').forEach(menu => menu.classList.add('hidden'));
                }
            });

            // --- INITIALIZATION ---
            const init = () => {
                const startDelay = 1600;
                setTimeout(() => {
                    splash.classList.add('hide');
                    setTimeout(() => splash.remove(), 520);
                    fetchCoffees();
                }, startDelay);
            };
            init();
        });
    </script>
</body>
</html>