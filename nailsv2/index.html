<!DOCTYPE html>
<html lang="hu" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nailverse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#E5E7EB',
                            200: '#D1D5DB',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="icon" type="image/x-icon" href="../img/favicon.ico">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen">
    <div class="container mx-auto px-2 py-6 max-w-2xl">
        <h1 class="text-4xl font-extrabold text-center mb-8 text-indigo-300 tracking-widest drop-shadow-lg">
            <span class="text-red-400">VIRAG'S</span> NAIL HEAVEN
        </h1>

        <!-- Color Picker Section -->
        <div class="bg-gray-900 rounded-lg shadow-md p-4 mb-6 border border-gray-700">
            <form id="addColorForm" class="flex flex-col gap-2 items-center justify-center w-full">
                <div class="flex flex-col items-center w-full">
                    <input type="color" id="colorInput" required
                        class="w-14 h-14 border-2 border-gray-700 rounded cursor-pointer transition-all mb-2">
                    <div id="presetColors" class="flex flex-wrap gap-2 justify-center mt-1"></div>
                    <button type="button" id="savePresetBtn"
                        class="mt-1 text-xs px-2 py-1 rounded bg-indigo-700 text-white hover:bg-indigo-800 transition-colors">
                        Szín mentése kedvencként
                    </button>
                </div>
                <div class="flex flex-wrap gap-2 justify-center mt-2">
                    <button type="button" id="clearSelectionBtn"
                        class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-200 hover:bg-gray-800 transition-colors">
                        Kijelölés törlése
                    </button>
                    <button type="button" id="yearViewBtn"
                        class="text-xs px-2 py-1 rounded bg-indigo-900 text-indigo-200 hover:bg-indigo-800 transition-colors">
                        Éves nézet
                    </button>
                </div>
            </form>
            <!-- Color Legend -->
            <div id="colorLegend" class="mt-4 w-full">
                <h3 class="text-sm font-semibold text-indigo-300 mb-1">Színek leírása:</h3>
                <div id="legendList" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Description + Save -->
        <div class="bg-gray-900 rounded-lg shadow-md p-4 mb-6 border border-gray-700">
            <input type="text" id="descInput" placeholder="Szín neve vagy leírás"
                class="border border-gray-700 bg-gray-800 text-gray-100 rounded px-3 py-2 focus:outline-none focus:border-indigo-500 transition-all w-full mb-2">
            <button id="applyToSelectedBtn"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition-colors font-medium w-full mb-2">
                Mentés a kijelölt napokra
            </button>
        </div>

        <!-- Calendar -->
        <div class="bg-gray-900 dark:bg-gray-900 rounded-lg shadow-md p-4 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <button id="prevMonth"
                    class="text-gray-300 hover:text-indigo-400 transition-colors text-2xl">&#8592;</button>
                <div id="monthLabel" class="text-xl font-semibold text-gray-100"></div>
                <button id="nextMonth"
                    class="text-gray-300 hover:text-indigo-400 transition-colors text-2xl">&#8594;</button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
            <div class="grid grid-cols-7 mt-2">
                <div class="text-xs text-center text-gray-400">H</div>
                <div class="text-xs text-center text-gray-400">K</div>
                <div class="text-xs text-center text-gray-400">Sz</div>
                <div class="text-xs text-center text-gray-400">Cs</div>
                <div class="text-xs text-center text-gray-400">P</div>
                <div class="text-xs text-center text-gray-400">Szo</div>
                <div class="text-xs text-center text-gray-400">V</div>
            </div>
        </div>
    </div>

    <script>
        // JSONBin.io config
        const BIN_ID = '68446a408561e97a5020b8c5';
        const API_KEY = '$2a$10$J7fi24LcCk1TF8IfMHC4.e/IaKxCzRvCdOdE5F3YrDVrMRjhID4lC';

        let colors = [];
        let currentMonth, currentYear;
        let presetColors = [];
        let selectedDates = [];

        document.addEventListener('DOMContentLoaded', () => {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('monthLabel');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const colorInput = document.getElementById('colorInput');
            const descInput = document.getElementById('descInput');
            const presetColorsDiv = document.getElementById('presetColors');
            const savePresetBtn = document.getElementById('savePresetBtn');

            document.body.classList.add('text-base', 'sm:text-base', 'md:text-lg');

            // Default: today
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            selectedDates = [`${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`];

            // ---- Preset Colors ----
            function loadPresets() {
                try {
                    presetColors = JSON.parse(localStorage.getItem('nailColorPresets') || '[]');
                } catch { presetColors = []; }
                if (!Array.isArray(presetColors)) presetColors = [];
                // Convert old string-only presets to object with color and empty desc
                presetColors = presetColors.map(p => typeof p === 'string' ? { color: p, desc: '' } : { color: p.color, desc: p.desc || '' });
                if (presetColors.length === 0) {
                    presetColors = [
                        { color: '#e57373', desc: '' },
                        { color: '#f06292', desc: '' }
                    ];
                }
            }
            function savePresets() {
                localStorage.setItem('nailColorPresets', JSON.stringify(presetColors));
            }
            function renderPresets() {
                presetColorsDiv.innerHTML = presetColors.map((preset, i) => {
                    let color = preset.color;
                    let desc = preset.desc || '';
                    return `<div class="bg-gray-800 rounded-lg shadow flex flex-col items-center p-2 w-24 group relative">
              <button type="button" class="w-8 h-8 rounded-full border-2 border-gray-600 focus:ring-2 focus:ring-indigo-400 transition-all mb-1" style="background:${color}" title="${color}" tabindex="0"></button>
              <span class="text-xs text-gray-400">${color}</span>
              <input type="text" value="${desc.replace(/"/g, '&quot;')}" class="text-xs text-gray-300 text-center break-words bg-gray-700 rounded px-1 py-0.5 mt-1 w-full focus:outline-none focus:border-indigo-400 border border-gray-600 preset-desc-input" data-index="${i}" placeholder="Név vagy leírás..." />
              <button type="button" class="absolute top-0 right-0 text-xs text-red-400 hover:text-red-600 transition-colors bg-gray-900 rounded-full px-1 py-0.5 opacity-0 group-hover:opacity-100" title="Törlés" tabindex="-1">×</button>
          </div>`;
                }).join('');
                Array.from(presetColorsDiv.children).forEach((card, i) => {
                    const colorBtn = card.querySelector('button');
                    colorBtn.addEventListener('click', () => {
                        const preset = presetColors[i];
                        colorInput.value = preset.color;
                        descInput.value = preset.desc || '';
                    });
                    const delBtn = card.querySelectorAll('button')[1];
                    delBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm('Törlöd ezt a kedvenc színt?')) {
                            presetColors.splice(i, 1);
                            savePresets();
                            renderPresets();
                        }
                    });
                    // Inline edit for description
                    const descInputEl = card.querySelector('.preset-desc-input');
                    descInputEl.addEventListener('change', (e) => {
                        presetColors[i].desc = e.target.value;
                        savePresets();
                        renderPresets();
                    });
                });
                // Render color legend (description list)
                const legendList = document.getElementById('legendList');
                if (legendList) {
                    legendList.innerHTML = presetColors
                        .map(preset => {
                            let color = preset.color;
                            let desc = preset.desc || '';
                            if (!desc) return '';
                            return `<div class="flex items-center gap-2 bg-gray-800 rounded px-2 py-1 mb-1">
                                <span class="inline-block w-5 h-5 rounded-full border-2 border-gray-600" style="background:${color}"></span>
                                <span class="text-xs text-gray-200">${desc}</span>
                            </div>`;
                        })
                        .filter(Boolean)
                        .join('');
                }
            }
            loadPresets();
            renderPresets();

            savePresetBtn.addEventListener('click', () => {
                const c = colorInput.value;
                const d = descInput.value.trim();
                if (!presetColors.some(p => p.color === c)) {
                    presetColors.push({ color: c, desc: d });
                    savePresets();
                    renderPresets();
                }
            });

            // ---- Month Navigation ----
            prevMonthBtn.addEventListener('click', () => {
                if (currentMonth === 0) { currentMonth = 11; currentYear--; }
                else currentMonth--;
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                if (currentMonth === 11) { currentMonth = 0; currentYear++; }
                else currentMonth++;
                renderCalendar();
            });

            // ---- Save colors ----
            document.getElementById('applyToSelectedBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                const color = colorInput.value;
                const desc = descInput.value.trim();
                if (!selectedDates.length || !color) return;
                for (const date of selectedDates) {
                    colors = colors.filter(c => c.date !== date);
                    colors.push({ date, color, desc });
                }
                await saveColors();
                renderCalendar();
            });

            document.getElementById('clearSelectionBtn').addEventListener('click', () => {
                selectedDates = [];
                renderCalendar();
            });

            document.getElementById('yearViewBtn').addEventListener('click', () => {
                window.location.href = 'year.html';
            });

            // ---- Calendar ----
            function getContrastYIQ(hexcolor) {
                hexcolor = hexcolor.replace('#', '');
                if (hexcolor.length === 3) hexcolor = hexcolor.split('').map(x => x + x).join('');
                const num = parseInt(hexcolor, 16);
                const r = (num >> 16) & 255, g = (num >> 8) & 255, b = num & 255;
                return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#222' : '#fff';
            }
            function renderCalendar() {
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const startDay = (firstDay + 6) % 7;
                let html = '';
                for (let i = 0; i < startDay; i++) html += '<div></div>';
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const entry = colors.find(c => c.date === dateStr);
                    const isSelected = selectedDates.includes(dateStr);
                    let border = entry ? 'border-2 border-white shadow-lg' : 'border border-gray-700';
                    let style = entry ? `background:${entry.color};color:${getContrastYIQ(entry.color)};` : '';
                    let ring = isSelected ? 'ring-4 ring-pink-400' : '';
                    html += `<div class="relative group rounded-lg p-1 sm:p-2 cursor-pointer transition-all ${ring} ${entry ? '' : 'hover:bg-gray-800 '}" data-date="${dateStr}">
              <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mx-auto flex items-center justify-center ${border}" style="${style}">
                ${entry ? `<span class="font-bold" style="color:${getContrastYIQ(entry.color)}">${day}</span>` : `<span class="text-xs text-gray-500">${day}</span>`}
              </div>
              ${entry ? `<div class="absolute z-10 left-1/2 -translate-x-1/2 bottom-0 translate-y-full bg-gray-800 text-gray-100 text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap mt-1 shadow">${entry.desc || ''}</div>` : ''}
              ${entry ? `<button onclick="event.stopPropagation();deleteColor('${dateStr}')" class="absolute top-0 right-0 text-xs text-red-400 hover:text-red-600 transition-colors bg-gray-900 rounded-full px-1 py-0.5">×</button>` : ''}
            </div>`;
                }
                calendarGrid.innerHTML = html;
                Array.from(calendarGrid.children).forEach(cell => {
                    if (cell.dataset && cell.dataset.date) {
                        cell.addEventListener('click', () => {
                            const date = cell.dataset.date;
                            if (selectedDates.includes(date)) selectedDates = selectedDates.filter(d => d !== date);
                            else selectedDates.push(date);
                            renderCalendar();
                        });
                    }
                });
                const monthNames = ['Január', 'Február', 'Március', 'Április', 'Május', 'Június', 'Július', 'Augusztus', 'Szeptember', 'Október', 'November', 'December'];
                monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            }

            // ---- Swipe Navigation ----
            let touchStartX = null;
            calendarGrid.addEventListener('touchstart', e => {
                if (e.touches.length === 1) touchStartX = e.touches[0].clientX;
            });
            calendarGrid.addEventListener('touchend', e => {
                if (touchStartX === null) return;
                const dx = e.changedTouches[0].clientX - touchStartX;
                if (Math.abs(dx) > 50) {
                    if (dx < 0) nextMonthBtn.click();
                    else prevMonthBtn.click();
                }
                touchStartX = null;
            });

            // ---- Global delete ----
            window.deleteColor = async function (date) {
                if (confirm('Biztosan törlöd ezt a színt?')) {
                    colors = colors.filter(c => c.date !== date);
                    await saveColors();
                    renderCalendar();
                }
            }

            async function loadColors() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        colors = data.record.colors || [];
                        renderCalendar();
                    } else {
                        calendarGrid.innerHTML = '<div class="col-span-full text-center text-red-500 py-10">Hiba a színek betöltésekor.</div>';
                    }
                } catch {
                    calendarGrid.innerHTML = '<div class="col-span-full text-center text-red-500 py-10">Hiba a szerverrel való kommunikáció során.</div>';
                }
            }
            async function saveColors() {
                try {
                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY, 'X-Bin-Versioning': 'false' },
                        body: JSON.stringify({ colors })
                    });
                } catch {
                    alert('Hiba a színek mentésekor. Próbáld újra!');
                }
            }

            // ---- Init ----
            loadColors();
            setInterval(loadColors, 20000);
            renderCalendar();
        });
    </script>
</body>

</html>